steps:
  # Step 1: Build all Docker services using docker-compose
  - name: 'gcr.io/cloud-builders/docker'
    dir: .
    args: ['compose', '-f', 'docker-compose.yml', 'build']

  # Step 2: SSH into the VM, pull latest code, and restart containers
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: bash
    args:
      - '-c'
      - |
        gcloud compute ssh harshvardhanthosar@instance-20250401-134435 \
          --zone=us-central1-b \
          --command="cd /home/harshvardhanthosar/celia-backend-poc && git pull && docker compose up --build -d"

timeout: 1200s  # 20 minutes

# Optional: Set logging behavior (fixes error when using a custom service account)
options:
  logging: CLOUD_LOGGING_ONLY